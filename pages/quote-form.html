<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Fuel Quote Request Form</title>
    <link rel="stylesheet" href="../style/fuel-quote.css">
</head>

<body>
    <header class="header-box">
        <div class="navbar">
            <a href="/"><img src="../images/logo.jpg" class="logo"></a>
            <ul>
                <li><a href="#">Home</a></li>
                <li><a href="user-profile.html">Profile Home</a></li>
                <li><a href="quote-history.html">Fuel History</a></li>
            </ul>
        </div>
    </header>

    <div class="form-container">
        <div class="header">
            <h1>Fuel Quote Request</h1>
            <p>Please fill in the indicated fields</p>
        </div>
        <form id="quoteForm" action="/quote-form" method="post">
            <input type="hidden" id="username" name="username">
            <label for="gallonsRequest">Gallons Requested<span style="color: red;">*</span>: </label>
            <input type="number" id="gallons" oninput="calculateFuelQuote()" required><br>

            <label for="deliveryAddress">Delivery Address: </label>
            <input type="text" class="readonly-input" id="addressInput" readonly><br>

            <label for="deliveryDate">Delivery Date: </label>
            <input type="date"><br>

            <label for="suggestedPrice">Suggested Price per Gallon: </label>
            <input type="number" class="readonly-input" id="price" value="0.00" readonly><br>

            <label for="amountDue">Total Amount Due: </label>
            <input type="number" class="readonly-input" id="total" value="0.00" readonly><br>

            <!-- Hidden input fields for factors -->
            <input type="hidden" id="locationFactor" value="0.02"> <!-- Default value for Texas -->
            <input type="hidden" id="rateHistoryFactor" value="0.01"> <!-- Default value for having history -->
            <input type="hidden" id="gallonsRequestedFactor" value="0.02"> <!-- Default value for more than 1000 gallons -->
            
            <div class="quoteButtons">
                <button type="button" class="quotebutton">Get Quote</button>
                <button type="submit" class="submitbutton">Submit</button>
            </div>

        </form>
        
    </div>
    
</body>

<script>
    const loggedInUser = localStorage.getItem('loggedInUser');

    if (!loggedInUser) {
        window.location.href = 'login.html';
    } else {
        document.getElementById('username').value = loggedInUser;
    }

    document.addEventListener("DOMContentLoaded", async function() {
    try {
        const addressResponse = await fetch('/get-address', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ username: loggedInUser })
        });

        if (!addressResponse.ok) {
            throw new Error('Failed to fetch address');
        }

        const addressData = await addressResponse.json();
        document.getElementById("addressInput").value = addressData.address;

        const state = addressData.state.toUpperCase(); // Normalize state to uppercase
        const locationFactor = (state === "TX") ? 0.02 : 0.04;
        document.getElementById("locationFactor").value = locationFactor;

        const historyResponse = await fetch('/get-rate-history-factor', { // New endpoint
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ username: loggedInUser })
        });

        if (!historyResponse.ok) {
            throw new Error('Failed to fetch rate history factor');
        }

        const historyData = await historyResponse.json();
        const rateHistoryFactor = historyData.rateHistoryFactor; // Get rate history factor
        document.getElementById("rateHistoryFactor").value = rateHistoryFactor;

    } catch (error) {
        console.error('Error during form setup:', error);
    }
});

    function calculateFuelQuote() {
        const gallons = parseFloat(document.getElementById("gallons").value);

        const currentPrice = 1.50; // Current price per gallon
    
        // Determine the gallons requested factor based on the number of gallons
        const gallonsRequestedFactor = gallons >= 1000 ? 0.02 : 0.03;
    
        // Update the hidden input field for gallons requested factor
        document.getElementById("gallonsRequestedFactor").value = gallonsRequestedFactor;

        const locationFactor = parseFloat(document.getElementById("locationFactor").value); // Location factor
        const rateHistoryFactor = parseFloat(document.getElementById("rateHistoryFactor").value); // Rate history factor
        const companyProfitFactor = 0.10; // Company profit factor

        const margin = currentPrice * (locationFactor - rateHistoryFactor + gallonsRequestedFactor + companyProfitFactor);
        const suggestedPrice = currentPrice + margin;

        const totalAmountDue = gallons * suggestedPrice;

        // Update the suggested price and total amount due in the form fields
        document.getElementById("price").value = suggestedPrice.toFixed(3);
        document.getElementById("total").value = totalAmountDue.toFixed(2);
}

        document.querySelector('.quotebutton').addEventListener('click', function(event) {
        event.preventDefault(); // Prevent form submission
        calculateFuelQuote(); // Calculate and update the suggested price and total amount due
});

        document.getElementById("quoteForm").addEventListener("submit", function(event) {
        event.preventDefault(); // Prevent default form submission

        calculateFuelQuote(); // Ensure calculated values are updated

        const formData = new FormData(event.target);

        fetch("/quote-form", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(Object.fromEntries(formData.entries()))
    })
        .then((response) => {
            if (!response.ok) {
                throw new Error("Submission failed");
        }
            alert("Fuel quote submitted successfully!");
    })
        .catch((error) => {
            console.error("Error:", error.message);
            alert("Failed to submit fuel quote. Please try again later.");
    });
});
</script>

</html>

