<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Fuel Quote Request Form</title>
    <link rel="stylesheet" href="../style/fuel-quote.css">
</head>

<body>
    <header class="header-box">
        <div class="navbar">
            <a href="/"><img src="../images/logo.jpg" class="logo"></a>
            <ul>
                <li><a href="#">Home</a></li>
                <li><a href="user-profile.html">Profile Home</a></li>
                <li><a href="quote-history.html">Fuel History</a></li>
            </ul>
        </div>
    </header>

    <div class="form-container">
        <div class="header">
            <h1>Fuel Quote Request</h1>
            <p>Please fill in the indicated fields</p>
        </div>
        <form id="quoteForm" action="/quote-form" method="post">
            <input type="hidden" id="username" name="username">
            <label for="gallonsRequest">Gallons Requested<span style="color: red;">*</span>: </label>
            <input type="number" id="gallons" oninput="calcTotal()" required><br>

            <label for="deliveryAddress">Delivery Address: </label>
            <!-- IMPLEMENT VALUE FROM CLIENT PROFILE -->
            <input type="text" class="readonly-input" id="addressInput" readonly>
            <br>

            <label for="deliveryDate">Delivery Date: </label>
            <input type="date" id="deliveryDate"><br>

            <!-- PLACEHOLDER VALUE. IMPLEMENT VALUE FROM PRICING MODULE -->
            <label for="suggestedPrice">Suggested Price per Gallon: </label>
            <input type="number" class="readonly-input" id="price" value="2.99" readonly><br>

            <!-- CALCULATED BY GALLONS * PRICE -->
            <label for="amountDue">Total Amount Due: </label>
            <input type="number" class="readonly-input" id="total"><br>
            
            <button type="submit">Submit</button>
        </form>
        
    </div>
</body>

<script src="/controllers/quoteForm.js"></script>

<script>
    // Check if the user is logged in
    const loggedInUser = localStorage.getItem('loggedInUser');

    // If user is not logged in, redirect to the login page
    if (!loggedInUser) {
        window.location.href = 'login.html';
    } else {
        // Populate the hidden username field with the logged-in user's username
        document.getElementById('username').value = loggedInUser;
    }

    fetch('/get-address', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ username: loggedInUser }) // Send the username of the logged-in user
    })
    .then(response => response.json())
    .then(data => {
        const address = data.address;
        document.getElementById('addressInput').value = address; // Populate the address field with the fetched address
    }) .catch(error => {
        console.error('Error fetching address:', error);
    });

    // Calculate total amount 
    function calcTotal() {
        var gallons = parseFloat(document.getElementById("gallons").value);
        var total = gallons * price;
        document.getElementById("amountDue").value = total.toFixed(2);
    }

    // const fetch = require('node-fetch'); 

    document.getElementById('quoteForm').addEventListener('submit', async function handleFormSubmission(event) {
        event.preventDefault(); // Prevent form submission

        const form = event.target;
        const formData = new FormData(form); // Get form data

        try {
            const response = await fetch('/quote-form', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(Object.fromEntries(formData.entries()))
            });

            if (!response.ok) {
                throw new Error('Network response was not ok');
            }

            alert('Fuel quote form submitted successfully!');
        } catch (error) {
            console.error('Error:', error.message);
            alert('Failed to submit fuel quote. Please try again later.');
        }
        document.getElementById('quote-form').addEventListener('submit', handleFormSubmission);
    });
</script>

</html>